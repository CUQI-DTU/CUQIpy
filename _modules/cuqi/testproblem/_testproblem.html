
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cuqi.testproblem._testproblem &#8212; cuqipy  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=321493ab" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-dropdown.css?v=995e94df" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-bootstrap.min.css?v=21c0b90a" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/cuqi/testproblem/_testproblem';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="https://github.com/CUQI-DTU/CUQIpy/raw/main/logo.png" class="logo__image only-light" alt="cuqipy  documentation - Home"/>
    <img src="https://github.com/CUQI-DTU/CUQIpy/raw/main/logo.png" class="logo__image only-dark pst-js-only" alt="cuqipy  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../dev/index.html">
    Contributor's Guide
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../dev/index.html">
    Contributor's Guide
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">cuqi.testproblem._testproblem</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for cuqi.testproblem._testproblem</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">toeplitz</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csc_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad_vec</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">fftconvolve</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">convolve1d</span>

<span class="kn">import</span> <span class="nn">cuqi</span>
<span class="kn">from</span> <span class="nn">cuqi.model</span> <span class="kn">import</span> <span class="n">LinearModel</span>
<span class="kn">from</span> <span class="nn">cuqi.distribution</span> <span class="kn">import</span> <span class="n">Gaussian</span>
<span class="kn">from</span> <span class="nn">cuqi.problem</span> <span class="kn">import</span> <span class="n">BayesianProblem</span>
<span class="kn">from</span> <span class="nn">cuqi.geometry</span> <span class="kn">import</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">MappedGeometry</span><span class="p">,</span> <span class="n">StepExpansion</span><span class="p">,</span> <span class="n">KLExpansion</span><span class="p">,</span> <span class="n">KLExpansion_Full</span><span class="p">,</span> <span class="n">CustomKL</span><span class="p">,</span> <span class="n">Continuous1D</span><span class="p">,</span> <span class="n">Continuous2D</span><span class="p">,</span> <span class="n">Image2D</span>
<span class="kn">from</span> <span class="nn">cuqi.array</span> <span class="kn">import</span> <span class="n">CUQIarray</span>
<span class="kn">import</span> <span class="nn">warnings</span>



<span class="c1">#=============================================================================</span>
<span class="k">class</span> <span class="nc">_Deblur</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1D Deblur test problem.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    dim : int, default 128</span>
<span class="sd">        size of the (dim,dim) deblur problem.</span>

<span class="sd">    bounds : len=2 list of int&#39;s, default [0,1]</span>
<span class="sd">        Lower and upper bounds for the mesh.</span>

<span class="sd">    blur_size : int, default 48</span>
<span class="sd">        size of blur.</span>

<span class="sd">    noise_std : scalar, default 0.1</span>
<span class="sd">        Standard deviation of the noise.</span>

<span class="sd">    prior : cuqi.distribution.Distribution, default Gaussian</span>
<span class="sd">        Distribution of the prior.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Generated (noisy) data</span>

<span class="sd">    model : cuqi.model.Model</span>
<span class="sd">        Deblur forward model</span>

<span class="sd">    likelihood : cuqi.likelihood.Likelihood</span>
<span class="sd">        Likelihood function.</span>

<span class="sd">    prior : cuqi.distribution.Distribution, Default Gaussian</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    exactSolution : ndarray</span>
<span class="sd">        Exact solution (ground truth)</span>

<span class="sd">    exactData : ndarray</span>
<span class="sd">        Noise free data</span>

<span class="sd">    mesh : ndarray</span>
<span class="sd">        The mesh the model is defined on.</span>

<span class="sd">    meshsize : float</span>
<span class="sd">        Size of each mesh element.</span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    MAP()</span>
<span class="sd">        Compute MAP estimate of posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    sample_posterior(Ns)</span>
<span class="sd">        Sample Ns samples of the posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">blur_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;DEPRECATED: Use Deconvolution1D instead.&quot;</span><span class="p">)</span>
        
        <span class="c1"># mesh</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="p">)</span>
        <span class="n">meshsize</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># set-up computational model kernel</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">blur_size</span><span class="p">:</span> <span class="n">blur_size</span> <span class="o">/</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">blur_size</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)))</span>   <span class="c1"># blurring kernel</span>

        <span class="c1"># convolution matrix</span>
        <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">meshsize</span><span class="o">*</span><span class="n">kernel</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">blur_size</span><span class="p">)</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">A</span><span class="p">[</span><span class="n">A</span> <span class="o">&lt;</span> <span class="mf">5e-3</span><span class="o">*</span><span class="n">maxval</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>   <span class="c1"># make A sparse</span>

        <span class="c1"># Store forward model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        
        <span class="c1"># Prior</span>
        <span class="k">if</span> <span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># Store data distribution</span>
        <span class="n">data_dist</span> <span class="o">=</span> <span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="n">noise_std</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        
        <span class="c1"># Generate inverse-crime free data (still same blur size)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">f_true</span><span class="p">,</span> <span class="n">g_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generateData</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">blur_size</span><span class="p">,</span> <span class="n">data_dist</span><span class="p">)</span>

        <span class="c1"># Likelihood</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">data_dist</span><span class="o">.</span><span class="n">to_likelihood</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1">#Initialize deblur as BayesianProblem cuqi problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>
        
        <span class="c1">#Store other properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshsize</span> <span class="o">=</span> <span class="n">meshsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">f_true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">g_true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        
    <span class="k">def</span> <span class="nf">_generateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mesh</span><span class="p">,</span><span class="n">kernel</span><span class="p">,</span><span class="n">blur_size</span><span class="p">,</span><span class="n">data_dist</span><span class="p">):</span>

        <span class="c1"># f is piecewise constant</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">conds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[(</span><span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">),</span>  \
                <span class="p">(</span><span class="mf">0.20</span>  <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">),</span> \
                <span class="p">(</span><span class="mf">0.6</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)]</span>
        <span class="n">f_signal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">conds</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">vals</span><span class="p">)</span>

        <span class="c1"># numerically integrate the convolution</span>
        <span class="n">g_conv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">quad_vec</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">f_signal</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">kernel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">blur_size</span><span class="p">),</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
        <span class="c1"># se also np.convolve(kernel(...), f_true, mode=&#39;same&#39;)</span>

        <span class="c1"># true values</span>
        <span class="n">f_true</span> <span class="o">=</span> <span class="n">f_signal</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">g_true</span> <span class="o">=</span> <span class="n">g_conv</span><span class="p">(</span><span class="n">mesh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># noisy data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">g_true</span> <span class="o">+</span> <span class="n">data_dist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)))</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span> <span class="c1">#np.squeeze(noise.sample(1)) #np.random.normal(loc=0, scale=self.sigma_obs, size=(self.dim))</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">f_true</span><span class="p">,</span> <span class="n">g_true</span>

<span class="c1">#=============================================================================</span>
<div class="viewcode-block" id="Deconvolution1D">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Deconvolution1D.html#cuqi.testproblem.Deconvolution1D">[docs]</a>
<span class="k">class</span> <span class="nc">Deconvolution1D</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Create a 1D periodic deconvolution test problem defined by the inverse problem</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{b} = \mathbf{A}\mathbf{x},</span>

<span class="sd">    where :math:`\mathbf{b}` is a (noisy) convolved signal,</span>
<span class="sd">    :math:`\mathbf{x}` is a sharp (clean) signal and</span>
<span class="sd">    :math:`\mathbf{A}` is a convolution operator.</span>

<span class="sd">    The convolution operator is defined by specifying a point spread function and</span>
<span class="sd">    boundary conditions and is computed via scipy.ndimage.convolve1D. By default,</span>
<span class="sd">    the matrix representation of the convolution operator is computed and stored.</span>

<span class="sd">    The inputs are padded to fit the boundary conditions.</span>
<span class="sd">    https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.convolve1d.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    dim : int, default 128</span>
<span class="sd">        size of the (dim,dim) deconvolution problem</span>

<span class="sd">    PSF : string or ndarray, default &#39;Gauss&#39;</span>
<span class="sd">        | Determines type of the underlying point spread function (PSF).</span>
<span class="sd">        | Depending if use_legacy is True or False, the following options are available:</span>
<span class="sd">        | &#39;Gauss&#39; - a 1D Gaussian blur function</span>
<span class="sd">        | &#39;Moffat&#39; - a 1D Moffat blur function (non-LEGACY only)</span>
<span class="sd">        | &#39;Defocus&#39; - an out-of-focus 1D blur function (non-LEGACY only)</span>
<span class="sd">        | &#39;sinc&#39; or &#39;prolate&#39; - a sinc function (LEGACY only)</span>
<span class="sd">        | &#39;vonMises&#39; - a periodic version of the Gauss function (LEGACY only)</span>
<span class="sd">        | ndarray - a custom PSF represented as a 1D ndarray.</span>

<span class="sd">    PSF_param : scalar, default depends on PSF</span>
<span class="sd">        | A parameter that determines the shape of the PSF;</span>
<span class="sd">        | the larger the parameter, the larger the blur on the signal.</span>
<span class="sd">        | Ignored if PSF is a ndarray.</span>

<span class="sd">    PSF_size : int, default equal to dim</span>
<span class="sd">        | The size of the PSF.</span>
<span class="sd">        | Ignored if PSF is a ndarray.</span>

<span class="sd">    BC : string, default &#39;periodic&#39;</span>
<span class="sd">        | Boundary conditions for the convolution.</span>
<span class="sd">        | &#39;zero&#39; - zero boundary conditions</span>
<span class="sd">        | &#39;periodic&#39; - periodic boundary conditions</span>
<span class="sd">        | &#39;Mirror&#39; - Reflected around center of last pixel boundary conditions</span>
<span class="sd">        | &#39;Reflect&#39; - Reflected around edge of last pixel boundary conditions</span>
<span class="sd">        | &#39;Nearest&#39; - Replicates last element of boundary</span>

<span class="sd">    phantom : string or ndarray, default &#39;sinc&#39;</span>
<span class="sd">        | The phantom that is sampled to produce the exact solution (signal).</span>
<span class="sd">        | &#39;Gauss&#39; - a Gaussian function</span>
<span class="sd">        | &#39;sinc&#39; - a sinc function</span>
<span class="sd">        | &#39;vonMises&#39; - a periodic version of the Gauss function</span>
<span class="sd">        | &#39;square&#39; - a &quot;top hat&quot; function</span>
<span class="sd">        | &#39;hat&#39; - a triangular hat function</span>
<span class="sd">        | &#39;bumps&#39; - two bumps</span>
<span class="sd">        | &#39;derivGauss&#39; - the first derivative of Gauss function</span>
<span class="sd">        | &#39;pc&#39; - Piece-wise constant phantom</span>
<span class="sd">        | &#39;skyscraper&#39; - Piece-wise constant phantom with multiple peaks</span>
<span class="sd">        | ndarray - a custom phantom</span>

<span class="sd">    phantom_param : scalar, default depends on phantom</span>
<span class="sd">        | A parameter that determines the horizontal scaling of the</span>
<span class="sd">        | function; the larger the parameter the more horizontally</span>
<span class="sd">        | compressed. Does not apply to phantom = &#39;bumps&#39;, &#39;pc&#39;, &#39;skyscraper&#39; or ndarray.</span>

<span class="sd">    noise_type : string, default &#39;gaussian&#39;</span>
<span class="sd">        | The type of noise</span>
<span class="sd">        | &quot;Gaussian&quot; - Additive Gaussian white noise¨</span>
<span class="sd">        | &quot;scaledGaussian&quot; - Gaussian noise with standard deviation</span>
<span class="sd">        |                    scaled by magnitude of the data for each</span>
<span class="sd">        |                    point.</span>

<span class="sd">    noise_std : scalar, default 0.01</span>
<span class="sd">        Standard deviation of the noise</span>

<span class="sd">    prior : cuqi.distribution.Distribution, Default Gaussian</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    use_legacy : bool, Default False</span>
<span class="sd">        If True, use the legacy matrix representation of the forward model.</span>
<span class="sd">        The legacy representation has different choices for the PSF.</span>
<span class="sd">        The data is scaled differently than the non-legacy representation.</span>
<span class="sd">        </span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Deconvolution1D.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Deconvolution1D.__init__.html#cuqi.testproblem.Deconvolution1D.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">PSF</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span>
        <span class="n">PSF_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">PSF_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">BC</span><span class="o">=</span><span class="s2">&quot;periodic&quot;</span><span class="p">,</span>
        <span class="n">phantom</span><span class="o">=</span><span class="s2">&quot;sinc&quot;</span><span class="p">,</span>
        <span class="n">phantom_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">noise_type</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
        <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">):</span>
        
        <span class="c1"># Set up forward model</span>
        <span class="k">if</span> <span class="n">use_legacy</span><span class="p">:</span> <span class="c1"># Legacy matrix representation</span>

            <span class="k">if</span> <span class="n">BC</span> <span class="o">!=</span> <span class="s2">&quot;periodic&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Legacy matrix representation only supports periodic boundary conditions&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">PSF_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Legacy matrix representation does not support PSF_size&quot;</span><span class="p">)</span>

            <span class="n">A</span> <span class="o">=</span> <span class="n">_getCirculantMatrix</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">range_geometry</span><span class="o">=</span><span class="n">Continuous1D</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="n">domain_geometry</span><span class="o">=</span><span class="n">Continuous1D</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># New convolution operator based on scipy.ndimage.convolve1d</span>

            <span class="n">Afun</span> <span class="o">=</span> <span class="n">_getConvolutionOperator</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">,</span> <span class="n">PSF_size</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span>

            <span class="c1"># For efficiency, we create a sparse matrix representation of the forward model,</span>
            <span class="c1"># instead of using the matrix-free representation. For 1D problems, there is</span>
            <span class="c1"># no need to use the matrix-free representation, since the matrix is small.</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Afun</span><span class="p">(</span><span class="n">Id</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)])</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1"># make it sparse</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">range_geometry</span><span class="o">=</span><span class="n">Continuous1D</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="n">domain_geometry</span><span class="o">=</span><span class="n">Continuous1D</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span>  

        <span class="c1"># Set up exact solution</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">phantom</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">phantom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dim</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;phantom must be a 1D array of length dim&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;phantom_param is ignored when phantom is a ndarray&quot;</span><span class="p">)</span>
            <span class="n">x_exact</span> <span class="o">=</span> <span class="n">phantom</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">x_exact</span> <span class="o">=</span> <span class="n">_getExactSolution</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">phantom</span><span class="p">,</span> <span class="n">phantom_param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown phantom type </span><span class="si">{</span><span class="n">phantom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">)</span>

        <span class="c1"># Generate exact data</span>
        <span class="n">y_exact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x_exact</span><span class="p">)</span>

        <span class="c1"># Set up prior</span>
        <span class="k">if</span> <span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># Define and add noise #TODO: Add Poisson and logpoisson</span>
        <span class="k">if</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="n">data_dist</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="n">noise_std</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;scaledgaussian&quot;</span><span class="p">:</span>
            <span class="n">data_dist</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="p">(</span><span class="n">y_exact</span><span class="o">*</span><span class="n">noise_std</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This noise type is not implemented&quot;</span><span class="p">)</span>
        
        <span class="c1"># Generate data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_dist</span><span class="p">(</span><span class="n">x_exact</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

        <span class="c1"># Likelihood</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">data_dist</span><span class="o">.</span><span class="n">to_likelihood</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Set up as Bayesian problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>

        <span class="c1"># Store exact values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">x_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">y_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infoString</span> <span class="o">=</span> <span class="s2">&quot;Noise type: Additive </span><span class="si">{}</span><span class="s2"> with std: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">noise_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span><span class="n">noise_std</span><span class="p">)</span></div>
</div>


<span class="k">def</span> <span class="nf">_getConvolutionOperator</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">,</span> <span class="n">PSF_size</span><span class="p">,</span> <span class="n">BC</span><span class="p">):</span>

    <span class="c1"># Boundary condition translation</span>
    <span class="k">if</span> <span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;zero&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span>
    <span class="k">elif</span> <span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;periodic&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;wrap&quot;</span>
    <span class="k">elif</span> <span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mirror&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;mirror&quot;</span>
    <span class="k">elif</span> <span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;reflect&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;reflect&quot;</span>
    <span class="k">elif</span> <span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nearest&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown boundary condition&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PSF_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">PSF_size</span> <span class="o">=</span> <span class="n">dim</span>
   
    <span class="c1"># PSF setup</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PSF</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PSF must be a 1D array&quot;</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">PSF</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
            <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_GaussPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;moffat&quot;</span><span class="p">:</span>
            <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_MoffatPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;defocus&quot;</span><span class="p">:</span>
            <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_DefocusPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown PSF type&quot;</span><span class="p">)</span>
    
    <span class="c1"># Convolution matrix</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">convolve1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_createPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Create a 1D normalized PSF of size PSF_size using the function PSF_func. &quot;&quot;&quot;</span>
    <span class="c1"># Set up grid points</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">PSF_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">PSF_size</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Compute the PSF</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF_func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Normalize the PSF.</span>
    <span class="n">PSF</span> <span class="o">/=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># find the center</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PSF</span> <span class="o">==</span> <span class="n">PSF</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_GaussPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Create a 1D normalized Gaussian PSF of size PSF_size with standard deviation PSF_param. &quot;&quot;&quot;</span>

    <span class="c1"># Set default value for PSF_param</span>
    <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">PSF_param</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># Set up Gaussian function</span>
    <span class="n">PSF_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">PSF_param</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">_createPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_func</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_MoffatPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Create a 1D normalized Moffat PSF of size PSF_size with standard deviation PSF_param. &quot;&quot;&quot;</span>

    <span class="c1"># Set default value for PSF_param</span>
    <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">PSF_param</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># Set up Moffat function</span>
    <span class="n">PSF_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">PSF_param</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_createPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_func</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_DefocusPSF_1D</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Create a 1D normalized defocus PSF of size PSF_size with standard deviation PSF_param. &quot;&quot;&quot;</span>

    <span class="c1"># Set default value for PSF_param</span>
    <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">PSF_param</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">PSF_size</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PSF_param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>    
        <span class="c1"># the PSF is a delta function and so the blurring matrix is I</span>
        <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">)</span>
        <span class="n">PSF</span><span class="p">[</span><span class="n">center</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">PSF_size</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">PSF_param</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PSF_size</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">aa</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PSF_param</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">PSF</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF</span> <span class="o">/</span> <span class="n">PSF</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getCirculantMatrix</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">PSF_param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GetCircMatrix  Create a circulant matrix for deconvolution examples</span>
<span class="sd">    </span>
<span class="sd">    _getCirculantMatrix(dim, PSF, PSF_param)</span>
<span class="sd">    </span>
<span class="sd">    Input:  dim = size of the circulant matrix A</span>
<span class="sd">            PSF = string that determined type of the underlying PSF</span>
<span class="sd">                    &#39;Gauss&#39; - a Gaussian function</span>
<span class="sd">                    &#39;sinc&#39; or &#39;prolate&#39; - a sinc function</span>
<span class="sd">                    &#39;vonMises&#39; - a periodic version of the Gauss function</span>
<span class="sd">                    ndarray - a custom PSF.</span>
<span class="sd">            PSF_param = a parameter that determines the shape of the PSF;</span>
<span class="sd">                    the larger the parameter, to slower the initial decay</span>
<span class="sd">                    of the singular values of A</span>

<span class="sd">    Output: circulant matrix</span>

<span class="sd">    Based on Matlab code by Per Christian Hansen, DTU Compute, April 7, 2021</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Circulant matrix not implemented for odd numbers&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;PSF_param is ignored when PSF is a ndarray&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PSF</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kernel must be a 1D array of length dim&quot;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1">#h = h/np.linalg.norm(h)**2 # TODO: Normalize</span>
        <span class="n">hflip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="k">return</span> <span class="n">toeplitz</span><span class="p">(</span><span class="n">hflip</span><span class="p">,</span><span class="n">h</span><span class="p">)</span> 

    <span class="n">dim_half</span> <span class="o">=</span> <span class="n">dim</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim_half</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">dim</span>

    <span class="k">if</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">PSF_param</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">PSF_param</span><span class="o">*</span><span class="n">grid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">hflip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="k">return</span> <span class="n">toeplitz</span><span class="p">(</span><span class="n">hflip</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>    

    <span class="k">elif</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;sinc&quot;</span> <span class="ow">or</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;prolate&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">PSF_param</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">PSF_param</span><span class="o">*</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">hflip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="k">return</span> <span class="n">toeplitz</span><span class="p">(</span><span class="n">hflip</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;vonmises&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PSF_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">PSF_param</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">grid</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="n">PSF_param</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">hflip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="k">return</span> <span class="n">toeplitz</span><span class="p">(</span><span class="n">hflip</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PSF </span><span class="si">{</span><span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2"> is not implemented for the legacy convolution operator.&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getExactSolution</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">phantom</span><span class="p">,</span> <span class="n">phantom_param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GetExactSolution  Create a periodic solution</span>
<span class="sd">    </span>
<span class="sd">     Input: dim = length of the vector x</span>
<span class="sd">            phantom = the phantom that is sampled to produce x</span>
<span class="sd">                    &#39;Gauss&#39; - a Gaussian function</span>
<span class="sd">                    &#39;sinc&#39; - a sinc function</span>
<span class="sd">                    &#39;vonMises&#39; - a periodic version of the Gauss function</span>
<span class="sd">                    &#39;square&#39; - a &quot;top hat&quot; function</span>
<span class="sd">                    &#39;hat&#39; - a triangular hat function</span>
<span class="sd">                    &#39;bumps&#39; - two bumps</span>
<span class="sd">                    &#39;derivGauss&#39; - the first derivative of Gauss function</span>
<span class="sd">                    &#39;pc&#39; - Piece-wise constant phantom with one tall peak and one wide peak</span>
<span class="sd">                    &#39;skyscraper&#39; - Piece-wise constant phantom with multiple peaks of varying height</span>
<span class="sd">            param = A parameter that determines the horizontal scaling of the</span>
<span class="sd">                    function; the larger the parameter the more horizontally</span>
<span class="sd">                    compressed. Does not apply to phantom = &#39;bumps&#39; or ndarray.</span>
<span class="sd">    </span>
<span class="sd">    Output: x = column vector, scaled such that max(x) = 1</span>

<span class="sd">    Based on Matlab code by Per Christian Hansen, DTU Compute, April 7, 2021</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phantom_param</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">phantom_param</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;sinc&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phantom_param</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">phantom_param</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>        

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;vonmises&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phantom_param</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dim</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">**</span><span class="n">phantom_param</span>

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;square&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phantom_param</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;square&#39; phantom_param must be larger than or equal to 3&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">dimh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="n">phantom_param</span><span class="p">))</span>
        <span class="n">x</span><span class="p">[(</span><span class="n">dimh</span><span class="o">-</span><span class="n">w</span><span class="p">):(</span><span class="n">dimh</span><span class="o">+</span><span class="n">w</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hat&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phantom_param</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;hat&#39; phantom_param must be larger than or equal to 3&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">dimh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="n">phantom_param</span><span class="p">))</span>
        <span class="n">x</span><span class="p">[(</span><span class="n">dimh</span><span class="o">-</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">):(</span><span class="n">dimh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">w</span>
        <span class="n">x</span><span class="p">[(</span><span class="n">dimh</span><span class="o">-</span><span class="mi">1</span><span class="p">):(</span><span class="n">dimh</span><span class="o">+</span><span class="n">w</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">w</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bumps&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;phantom_param is not used for phantom = &#39;bumps&#39;&quot;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">dim</span>
        <span class="n">a1</span> <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span> <span class="n">c1</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="n">t1</span> <span class="o">=</span>  <span class="mf">0.8</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span> <span class="n">c2</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">;</span> <span class="n">t2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dim</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grid</span><span class="o">*</span><span class="n">h</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grid</span><span class="o">*</span><span class="n">h</span> <span class="o">-</span> <span class="n">t2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;derivgauss&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phantom_param</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">_getExactSolution</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span><span class="n">phantom_param</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pc&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;phantom_param is not used for phantom = &#39;pc&#39;&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">conds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[(</span><span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">),</span>  \
                <span class="p">(</span><span class="mf">0.20</span>  <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">),</span> \
                <span class="p">(</span><span class="mf">0.6</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)]</span>
        <span class="n">f_signal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">conds</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">vals</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f_signal</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">elif</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;skyscraper&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phantom_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;phantom_param is not used for phantom = &#39;skyscraper&#39;&quot;</span><span class="p">)</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">x_max</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">conds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[(</span><span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.10</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.10</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.20</span><span class="p">),</span>  \
                        <span class="p">(</span><span class="mf">0.20</span>  <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.35</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.35</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.38</span><span class="p">),</span>\
                        <span class="p">(</span><span class="mf">0.38</span>  <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.45</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.45</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.55</span><span class="p">),</span> \
                        <span class="p">(</span><span class="mf">0.55</span>  <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.8</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)]</span>
        <span class="n">f_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">conds</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">vals</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f_fun</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This phantom is not implemented&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Poisson1D">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Poisson1D.html#cuqi.testproblem.Poisson1D">[docs]</a>
<span class="k">class</span> <span class="nc">Poisson1D</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1D Poisson test problem. Discretized 1D Poisson equation (steady-state linear PDE).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    dim : int</span>
<span class="sd">        | size of the grid for the poisson problem</span>

<span class="sd">    endpoint : float</span>
<span class="sd">        | Location of end-point of grid.</span>
<span class="sd">    </span>
<span class="sd">    source : lambda function</span>
<span class="sd">        | Function for source term.</span>

<span class="sd">    field_type : str or cuqi.geometry.Geometry</span>
<span class="sd">        | Field type of domain. The accepted values are:</span>
<span class="sd">        | a Geometry object.</span>
<span class="sd">        | &quot;KL&quot;: a :class:`cuqi.geometry.KLExpansion` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | &quot;KL_Full&quot;: a :class:`cuqi.geometry.KLExpansion_Full` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | &quot;Step&quot;: a :class:`cuqi.geometry.StepExpansion` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | &quot;CustomKL&quot;: a :class:`cuqi.geometry.CustomKL` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | None: a :class:`cuqi.geometry.Continuous1D` geometry object will be created and set as a domain geometry.</span>

<span class="sd">    field_params : dict</span>
<span class="sd">        | A dictionary of key word arguments that the underlying geometry accepts. (Passed to the underlying geometry when field type is `KL`, `KL_Full`, `CustomKL`, `Step`). For example, for `Step` field type, the dictionary can be `{&quot;n_steps&quot;: 3}`.</span>

<span class="sd">    map : lambda function</span>
<span class="sd">        | Mapping used to modify field.</span>

<span class="sd">    imap : lambda function</span>
<span class="sd">        | Inverse of KL map.</span>

<span class="sd">    SNR : int</span>
<span class="sd">        | Signal-to-noise ratio</span>


<span class="sd">    observation_grid_map : lambda function</span>
<span class="sd">        | Function that takes the grid as input and returns a sub-grid of the nodes where observations are available, e.g. `observation_grid_map = lambda x: x[np.where(x&gt;5.0)]`. </span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Generated (noisy) data</span>

<span class="sd">    model : cuqi.model.PDEModel</span>
<span class="sd">        Poisson 1D model</span>

<span class="sd">    prior : cuqi.distribution.Distribution</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    likelihood : cuqi.likelihood.Likelihood</span>
<span class="sd">        Likelihood function</span>

<span class="sd">    exactSolution : ndarray</span>
<span class="sd">        Exact solution (ground truth)</span>

<span class="sd">    exactData : ndarray</span>
<span class="sd">        Noise free data   </span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    MAP()</span>
<span class="sd">        Compute MAP estimate of posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    sample_posterior(Ns)</span>
<span class="sd">        Sample Ns samples of the posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Poisson1D.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Poisson1D.__init__.html#cuqi.testproblem.Poisson1D.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span> <span class="p">(</span><span class="n">xs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">0.02</span><span class="p">),</span> <span class="n">field_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SNR</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">observation_grid_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exactSolution</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Prepare PDE form</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">dim</span><span class="o">-</span><span class="mi">1</span>   <span class="c1"># Number of solution nodes</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">/</span><span class="n">N</span>   <span class="c1"># step size</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Dx</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#Dx</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">Dx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Dx</span> <span class="o">/=</span> <span class="n">dx</span> <span class="c1"># FD derivative matrix</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        
        <span class="c1"># Grids for model</span>
        <span class="n">grid_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grid_range</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># PDE form: LHS(x)u=rhs(x)</span>
        <span class="n">grid_obs</span> <span class="o">=</span> <span class="n">grid_range</span>
        <span class="k">if</span> <span class="n">observation_grid_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid_obs</span> <span class="o">=</span> <span class="n">observation_grid_map</span><span class="p">(</span><span class="n">grid_range</span><span class="p">)</span>
        <span class="n">PDE_form</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">Dx</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">@</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="n">PDE</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">pde</span><span class="o">.</span><span class="n">SteadyStateLinearPDE</span><span class="p">(</span><span class="n">PDE_form</span><span class="p">,</span> <span class="n">grid_sol</span><span class="o">=</span><span class="n">grid_range</span><span class="p">,</span>  <span class="n">grid_obs</span><span class="o">=</span><span class="n">grid_obs</span><span class="p">)</span>

        <span class="c1"># Set up geometries for model</span>
        <span class="k">if</span> <span class="n">field_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span><span class="n">Geometry</span><span class="p">):</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">field_type</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;KL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">KLExpansion</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;KL_Full&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">KLExpansion_Full</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;Step&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">StepExpansion</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;CustomKL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">CustomKL</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">MappedGeometry</span><span class="p">(</span><span class="n">domain_geometry</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">imap</span><span class="p">)</span>

        <span class="n">range_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid_obs</span><span class="p">)</span>

        <span class="c1"># Prepare model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">PDEModel</span><span class="p">(</span><span class="n">PDE</span><span class="p">,</span><span class="n">range_geometry</span><span class="p">,</span><span class="n">domain_geometry</span><span class="p">)</span>

        <span class="c1"># Set up exact solution</span>
        <span class="k">if</span> <span class="n">exactSolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_exact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">5</span><span class="o">*</span><span class="n">grid_domain</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">grid_domain</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-</span><span class="n">grid_domain</span><span class="p">)</span> <span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">x_exact</span> <span class="o">=</span> <span class="n">exactSolution</span> 
        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span> <span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>

        <span class="c1"># Generate exact data</span>
        <span class="n">y_exact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span><span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Add noise to data</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y_exact</span><span class="p">)</span><span class="o">/</span><span class="n">SNR</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">*</span><span class="n">sigma</span> <span class="c1"># variance of the observation Gaussian noise</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">y_exact</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_exact</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Bayesian model</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain_dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">)</span>

        <span class="c1"># Initialize Deconvolution as BayesianProblem problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Store exact values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">x_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">y_exact</span></div>
</div>


<div class="viewcode-block" id="Heat1D">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Heat1D.html#cuqi.testproblem.Heat1D">[docs]</a>
<span class="k">class</span> <span class="nc">Heat1D</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1D Heat test problem. Discretized Heat equation (time-dependent linear PDE).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    dim : int</span>
<span class="sd">        | size of the grid for the heat problem</span>

<span class="sd">    endpoint : float</span>
<span class="sd">        | Location of end-point of grid.</span>
<span class="sd">    </span>
<span class="sd">    max_time : float</span>
<span class="sd">        | The last time step.</span>
<span class="sd">    </span>
<span class="sd">    field_type : str or cuqi.geometry.Geometry</span>
<span class="sd">        | Field type of domain. The accepted values are:</span>
<span class="sd">        | a Geometry object.</span>
<span class="sd">        | &quot;KL&quot;: a :class:`cuqi.geometry.KLExpansion` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | &quot;KL_Full&quot;: a :class:`cuqi.geometry.KLExpansion_Full` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | &quot;Step&quot;: a :class:`cuqi.geometry.StepExpansion` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | &quot;CustomKL&quot;: a :class:`cuqi.geometry.CustomKL` geometry object will be created and set as a domain geometry.</span>
<span class="sd">        | None: a :class:`cuqi.geometry.Continuous1D` geometry object will be created and set as a domain geometry.</span>

<span class="sd">    field_params : dict</span>
<span class="sd">        | A dictionary of key word arguments that the underlying geometry accepts. (Passed to the underlying geometry when field type is `KL`, `KL_Full`, `CustomKL`, `Step`). For example, for `Step` field type, the dictionary can be `{&quot;n_steps&quot;: 3}`.</span>

<span class="sd">    map : lambda function</span>
<span class="sd">        | If given, an underlying `MappedGeometry` geometry object is created which applies the mapping on the field, e.g. for log parameterization: `map = lambda x:np.exp(x)`.</span>

<span class="sd">    imap : lambda function</span>
<span class="sd">        | The inverse of the provided map. </span>

<span class="sd">    SNR : int</span>
<span class="sd">        | Signal-to-noise ratio</span>

<span class="sd">    exactSolution : ndarray or CUQIarray</span>
<span class="sd">        | The exact solution of the problem which is the heat model initial condition in this test problem. If provided as None, an exact solution is generated, if provided as ndarray, it is assumed to be function values and it is converted to a CUQIarray.</span>


<span class="sd">    observation_grid_map : lambda function</span>
<span class="sd">       | Function that takes the grid as input and returns a sub-grid of the nodes where observations are available, e.g. `observation_grid_map = lambda x: x[np.where(x&gt;5.0)]`. </span>
<span class="sd"> </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Generated (noisy) data</span>

<span class="sd">    model : cuqi.model.PDEModel</span>
<span class="sd">        Heat 1D model</span>

<span class="sd">    prior : cuqi.distribution.Distribution</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    likelihood : cuqi.likelihood.Likelihood</span>
<span class="sd">        Likelihood function</span>

<span class="sd">    exactSolution : ndarray</span>
<span class="sd">        Exact solution (ground truth)</span>

<span class="sd">    exactData : ndarray</span>
<span class="sd">        Noise free data   </span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    MAP()</span>
<span class="sd">        Compute MAP estimate of posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    sample_posterior(Ns)</span>
<span class="sd">        Sample Ns samples of the posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Heat1D.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Heat1D.__init__.html#cuqi.testproblem.Heat1D.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_time</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">field_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SNR</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">exactSolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">observation_grid_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        

        <span class="c1"># Prepare PDE form</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">dim</span>   <span class="c1"># Number of solution nodes</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># space step size</span>
        <span class="n">cfl</span> <span class="o">=</span> <span class="mi">5</span><span class="o">/</span><span class="mi">11</span> <span class="c1"># the cfl condition to have a stable solution</span>
        <span class="n">dt_approx</span> <span class="o">=</span> <span class="n">cfl</span><span class="o">*</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># defining approximate time step size</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_time</span><span class="o">/</span><span class="n">dt_approx</span><span class="p">)</span> <span class="c1"># number of time steps</span>
        <span class="n">Dxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># FD diffusion operator</span>
        
        <span class="c1"># Grids for model</span>
        <span class="n">grid_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">grid_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_time</span><span class="p">,</span><span class="n">max_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># PDE form (diff_op, IC, time_steps)</span>
        <span class="n">grid_obs</span> <span class="o">=</span> <span class="n">grid_range</span>
        <span class="k">if</span> <span class="n">observation_grid_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid_obs</span> <span class="o">=</span> <span class="n">observation_grid_map</span><span class="p">(</span><span class="n">grid_obs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">PDE_form</span><span class="p">(</span><span class="n">IC</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">Dxx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">IC</span><span class="p">)</span>
        <span class="n">PDE</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">pde</span><span class="o">.</span><span class="n">TimeDependentLinearPDE</span><span class="p">(</span>
            <span class="n">PDE_form</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">grid_sol</span><span class="o">=</span><span class="n">grid_domain</span><span class="p">,</span> <span class="n">grid_obs</span><span class="o">=</span><span class="n">grid_obs</span><span class="p">)</span>

        <span class="c1"># Set up geometries for model</span>
        <span class="k">if</span> <span class="n">field_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span><span class="n">Geometry</span><span class="p">):</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">field_type</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;KL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">KLExpansion</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;KL_Full&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">KLExpansion_Full</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;Step&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">StepExpansion</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;CustomKL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">CustomKL</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">,</span> <span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid_domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">MappedGeometry</span><span class="p">(</span><span class="n">domain_geometry</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">imap</span><span class="p">)</span>
        <span class="n">range_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid_obs</span><span class="p">)</span>

        <span class="c1"># Prepare model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">PDEModel</span><span class="p">(</span><span class="n">PDE</span><span class="p">,</span><span class="n">range_geometry</span><span class="p">,</span><span class="n">domain_geometry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exactSolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">exactSolution</span><span class="p">,</span> <span class="n">is_par</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>
        <span class="c1"># Set up exact solution</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;Step&quot;</span><span class="p">:</span>
                <span class="n">n_steps</span> <span class="o">=</span> <span class="n">domain_geometry</span><span class="o">.</span><span class="n">n_steps</span>
                <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">domain_geometry</span><span class="o">.</span><span class="n">par2fun</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">))),</span> <span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grid_domain</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">domain_geometry</span><span class="o">.</span><span class="n">grid</span>
                <span class="n">x_exact</span> <span class="o">=</span> <span class="n">grid_domain</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">grid_domain</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-</span><span class="n">grid_domain</span><span class="p">)</span>
                <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span> <span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>
        <span class="c1">#x_exact = 100*grid_domain*np.exp(-5*grid_domain)*np.sin(endpoint-grid_domain)</span>
        <span class="c1"># Generate exact data</span>
        <span class="n">y_exact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span> <span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Add noise to data</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y_exact</span><span class="p">)</span><span class="o">/</span><span class="n">SNR</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">*</span><span class="n">sigma</span> <span class="c1"># variance of the observation Gaussian noise</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">y_exact</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_exact</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Bayesian model</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain_dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">sigma2</span><span class="p">)</span>

        <span class="c1"># Initialize Heat1D as BayesianProblem problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Store exact values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">x_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">y_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infoString</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Noise type: Additive i.i.d. noise with mean zero and signal to noise ratio: </span><span class="si">{</span><span class="n">SNR</span><span class="si">}</span><span class="s2">&quot;</span></div>
</div>



<div class="viewcode-block" id="Abel1D">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Abel1D.html#cuqi.testproblem.Abel1D">[docs]</a>
<span class="k">class</span> <span class="nc">Abel1D</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1D Abel test problem. 1D model of rotationally symmetric computed tomography.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    dim : int</span>
<span class="sd">        size of the grid for the problem</span>

<span class="sd">    endpoint : float</span>
<span class="sd">        Location of end-point of grid.</span>
<span class="sd">    </span>
<span class="sd">    field_type : str or cuqi.geometry.Geometry</span>
<span class="sd">        Field type of domain.</span>

<span class="sd">    KL_map : lambda function</span>
<span class="sd">        Mapping used to modify field.</span>

<span class="sd">    KL_imap : lambda function</span>
<span class="sd">        Inverse of KL map.</span>

<span class="sd">    SNR : int</span>
<span class="sd">        Signal-to-noise ratio</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Generated (noisy) data</span>

<span class="sd">    model : cuqi.model.LinearModel</span>
<span class="sd">        Abel 1D model</span>

<span class="sd">    prior : cuqi.distribution.Distribution</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    likelihood : cuqi.likelihood.Likelihood</span>
<span class="sd">        Likelihood function</span>

<span class="sd">    exactSolution : ndarray</span>
<span class="sd">        Exact solution (ground truth)</span>

<span class="sd">    exactData : ndarray</span>
<span class="sd">        Noise free data   </span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    MAP()</span>
<span class="sd">        Compute MAP estimate of posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    sample_posterior(Ns)</span>
<span class="sd">        Sample Ns samples of the posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Abel1D.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Abel1D.__init__.html#cuqi.testproblem.Abel1D.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">KL_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">KL_imap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SNR</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">dim</span> <span class="c1"># number of quadrature points</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">/</span><span class="n">N</span> <span class="c1"># quadrature weight</span>

        <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
        <span class="n">svec</span> <span class="o">=</span> <span class="n">tvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">tvec</span><span class="p">,</span> <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">smat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">svec</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tmat</span><span class="o">&lt;</span><span class="n">smat</span><span class="p">)</span> <span class="c1"># only applying the quadrature on 0&lt;x&lt;1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">])</span> <span class="c1"># Abel integral operator</span>
        <span class="n">A</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">smat</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">tmat</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span> <span class="p">)</span>

        <span class="c1"># discretization</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

        <span class="c1"># Geometry</span>
        <span class="k">if</span> <span class="n">field_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span><span class="n">Geometry</span><span class="p">):</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">field_type</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;KL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">KLExpansion</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;Step&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">StepExpansion</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;CustomKL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">CustomKL</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="o">**</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KL_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">MappedGeometry</span><span class="p">(</span><span class="n">domain_geometry</span><span class="p">,</span><span class="n">KL_map</span><span class="p">,</span><span class="n">KL_imap</span><span class="p">)</span>

        <span class="n">range_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># Set up model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">range_geometry</span><span class="o">=</span><span class="n">range_geometry</span><span class="p">,</span> <span class="n">domain_geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>
    
        <span class="c1"># Set up exact solution</span>
        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tvec</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tvec</span><span class="p">)</span>
        <span class="n">x_exact</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,)</span>
        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span> <span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>

        <span class="c1"># Generate exact data</span>
        <span class="n">y_exact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span><span class="n">is_par</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Add noise to data</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y_exact</span><span class="p">)</span><span class="o">/</span><span class="n">SNR</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">*</span><span class="n">sigma</span> <span class="c1"># variance of the observation Gaussian noise</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">y_exact</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_exact</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>

        <span class="c1"># Bayesian model</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain_dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">sigma2</span><span class="p">)</span>
        
        <span class="c1"># Initialize Deconvolution as BayesianProblem problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Store exact values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">x_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">y_exact</span></div>
</div>



<span class="k">class</span> <span class="nc">_Deconv_1D</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1D Deconvolution test problem. Discreate linear problem from blurring kernel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    dim : int</span>
<span class="sd">        size of the grid for the problem</span>

<span class="sd">    endpoint : float</span>
<span class="sd">        Location of end-point of grid.</span>
<span class="sd">    </span>
<span class="sd">    field_type : str or cuqi.geometry.Geometry</span>
<span class="sd">        Field type of domain.</span>

<span class="sd">    KL_map : lambda function</span>
<span class="sd">        Mapping used to modify field.</span>

<span class="sd">    KL_imap : lambda function</span>
<span class="sd">        Inverse of KL map.</span>

<span class="sd">    SNR : int</span>
<span class="sd">        Signal-to-noise ratio</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Generated (noisy) data</span>

<span class="sd">    model : cuqi.model.LinearModel</span>
<span class="sd">        Deconvolution 1D model</span>

<span class="sd">    prior : cuqi.distribution.Distribution</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    likelihood : cuqi.likelihood.Likelihood</span>
<span class="sd">        Likelihood function</span>

<span class="sd">    exactSolution : ndarray</span>
<span class="sd">        Exact solution (ground truth)</span>

<span class="sd">    exactData : ndarray</span>
<span class="sd">        Noise free data   </span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    MAP()</span>
<span class="sd">        Compute MAP estimate of posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    sample_posterior(Ns)</span>
<span class="sd">        Sample Ns samples of the posterior.</span>
<span class="sd">        NB: Requires prior to be defined.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blur_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">field_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">KL_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">KL_imap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SNR</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;DEPRECATED: Use Deconvolution1D instead.&quot;</span><span class="p">)</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="n">dim</span> <span class="c1"># number of quadrature points</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">/</span><span class="n">N</span> <span class="c1"># quadrature weight</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">blur_size_var</span><span class="p">:</span> <span class="n">blur_size_var</span> <span class="o">/</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">blur_size</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)))</span>   <span class="c1"># blurring kernel</span>
        
        <span class="c1"># convolution matrix</span>
        <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="n">kernel</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">blur_size</span><span class="p">)</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">A</span><span class="p">[</span><span class="n">A</span> <span class="o">&lt;</span> <span class="mf">5e-3</span><span class="o">*</span><span class="n">maxval</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>   <span class="c1"># make A sparse</span>
        
        <span class="c1"># discretization</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span><span class="n">Geometry</span><span class="p">):</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">field_type</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;KL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">KLExpansion</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;Step&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">StepExpansion</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_type</span><span class="o">==</span><span class="s2">&quot;CustomKL&quot;</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">CustomKL</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">field_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KL_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">MappedGeometry</span><span class="p">(</span><span class="n">domain_geometry</span><span class="p">,</span><span class="n">KL_map</span><span class="p">,</span><span class="n">KL_imap</span><span class="p">)</span>

        <span class="n">range_geometry</span> <span class="o">=</span> <span class="n">Continuous1D</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># Set up model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">range_geometry</span><span class="o">=</span><span class="n">range_geometry</span><span class="p">,</span> <span class="n">domain_geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>
    
        <span class="c1"># Prior</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain_dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># Set up exact solution</span>
        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

        <span class="c1"># Generate exact data</span>
        <span class="n">y_exact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x_exact</span><span class="p">)</span>

        <span class="c1"># Add noise to data</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y_exact</span><span class="p">)</span><span class="o">/</span><span class="n">SNR</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">*</span><span class="n">sigma</span> <span class="c1"># variance of the observation Gaussian noise</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">y_exact</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_exact</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_likelihood</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Initialize Deconvolution as BayesianProblem problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>

        <span class="c1"># Store exact values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">x_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">y_exact</span>


<span class="c1">#=============================================================================</span>
<div class="viewcode-block" id="Deconvolution2D">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Deconvolution2D.html#cuqi.testproblem.Deconvolution2D">[docs]</a>
<span class="k">class</span> <span class="nc">Deconvolution2D</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Create a 2D Deconvolution test problem defined by the inverse problem</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{b} = \mathbf{A}\mathbf{x},</span>

<span class="sd">    where :math:`\mathbf{b}` is a (noisy) blurred image,</span>
<span class="sd">    :math:`\mathbf{x}` is a sharp image and</span>
<span class="sd">    :math:`\mathbf{A}` is a convolution operator.</span>

<span class="sd">    The convolution operator is defined by specifying a point spread function and</span>
<span class="sd">    boundary conditions and is computed (matrix-free) via scipy.signal.fftconvolve.</span>
<span class="sd">    The inputs are padded to fit the boundary conditions.</span>
<span class="sd">    https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.fftconvolve.html.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dim : int</span>
<span class="sd">        | size of the (dim,dim) deconvolution problem</span>

<span class="sd">    PSF : string or ndarray</span>
<span class="sd">        | Determines type of the underlying point spread function (PSF).</span>
<span class="sd">        | &#39;Gauss&#39; - a Gaussian blur</span>
<span class="sd">        | &#39;Moffat&#39; - a Moffat blur blur</span>
<span class="sd">        | &#39;Defocus&#39; - an out-of-focus blur</span>
<span class="sd">        | ndarray - Custom user-specified PSF</span>

<span class="sd">    PSF_param : scalar</span>
<span class="sd">        | A parameter that determines the shape of the PSF;</span>
<span class="sd">        | the larger the parameter, the larger blur on the image.</span>
<span class="sd">        | Ignored if PSF is given as ndarray</span>

<span class="sd">    PSF_size : int</span>
<span class="sd">        | Defines the size of the PSF. The size becomes (PSF_size, PSF_size).</span>
<span class="sd">        | Ignored if PSF is given as ndarray</span>

<span class="sd">    BC : string</span>
<span class="sd">        | Boundary conditions of convolution</span>
<span class="sd">        | &#39;zero&#39; - Zero boundary</span>
<span class="sd">        | &#39;periodic&#39; - Periodic boundary</span>
<span class="sd">        | &#39;Neumann&#39; - Neumann (reflective) boundary</span>
<span class="sd">        | &#39;Mirror&#39; - Mirrored boundary</span>
<span class="sd">        | &#39;Nearest&#39; - Replicates last element of boundary</span>
<span class="sd">        </span>
<span class="sd">    phantom : string or ndarray</span>
<span class="sd">        | The phantom (sharp image) that is convolved.</span>
<span class="sd">        | If ndarray it should be a square 2D array representing an image.</span>
<span class="sd">        | The image will automatically be resized to fit the problem size.</span>
<span class="sd">        | If string it should be any 2D phantom defined in cuqi.data.</span>
<span class="sd">        | The string is lowercased and any hyphens are replaced </span>
<span class="sd">        | with underscores to match a method name in cuqi.data.</span>
<span class="sd">        | Examples:</span>
<span class="sd">        | &#39;astronaut&#39; - a photo of an astronaut.</span>
<span class="sd">        | &#39;camera&#39; - a photo of a man with a camera.</span>
<span class="sd">        | &#39;cat&#39; - a photo of a cat.</span>
<span class="sd">        | &#39;cookie&#39; - cartoon cookie.</span>
<span class="sd">        | &#39;satellite&#39; - a photo of a satellite.</span>

<span class="sd">    noise_type : string</span>
<span class="sd">        | The type of noise</span>
<span class="sd">        | &quot;Gaussian&quot; - Gaussian white noise¨</span>
<span class="sd">        | &quot;scaledGaussian&quot; - Gaussian noise where standard deviation is scaled by by data.</span>

<span class="sd">    noise_std : scalar</span>
<span class="sd">        | Standard deviation of the noise.</span>

<span class="sd">    prior : Distribution</span>
<span class="sd">        | Option to set the prior distribution.</span>
<span class="sd">        | If set all components of the posterior</span>
<span class="sd">        | are defined and sampling can be achieved.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : CUQIarray</span>
<span class="sd">        Generated (noisy) data</span>

<span class="sd">    model : Model</span>
<span class="sd">        Deconvolution forward model</span>

<span class="sd">    prior : Distribution</span>
<span class="sd">        Distribution of the prior</span>

<span class="sd">    likelihood : Likelihood</span>
<span class="sd">        The likelihood function</span>
<span class="sd">        (automatically computed from data distribution)</span>

<span class="sd">    exactSolution : CUQIarray</span>
<span class="sd">        Exact solution (ground truth)</span>

<span class="sd">    exactData : CUQIarray</span>
<span class="sd">        Noise free data.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    MAP()</span>
<span class="sd">        Compute MAP estimate of posterior.</span>
<span class="sd">        NB: Requires prior to be defined</span>

<span class="sd">    sample_posterior(Ns)</span>
<span class="sd">        Sample Ns samples of the posterior.</span>
<span class="sd">        NB: Requires prior to be defined</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Deconvolution2D.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.Deconvolution2D.__init__.html#cuqi.testproblem.Deconvolution2D.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">PSF</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span>
        <span class="n">PSF_param</span><span class="o">=</span><span class="mf">2.56</span><span class="p">,</span>
        <span class="n">PSF_size</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
        <span class="n">BC</span><span class="o">=</span><span class="s2">&quot;periodic&quot;</span><span class="p">,</span>
        <span class="n">phantom</span><span class="o">=</span><span class="s2">&quot;satellite&quot;</span><span class="p">,</span>
        <span class="n">noise_type</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
        <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.0036</span><span class="p">,</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="c1"># setting up the geometry</span>
        <span class="n">domain_geometry</span> <span class="o">=</span> <span class="n">Image2D</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
        <span class="n">range_geometry</span> <span class="o">=</span> <span class="n">Image2D</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>

        <span class="c1"># set boundary conditions</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;neumann&quot;</span><span class="p">):</span>
            <span class="n">BC</span> <span class="o">=</span> <span class="s2">&quot;symmetric&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;zero&quot;</span><span class="p">):</span>
            <span class="n">BC</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span> <span class="c1"># cval = 0</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nearest&quot;</span><span class="p">):</span>
            <span class="n">BC</span> <span class="o">=</span> <span class="s2">&quot;edge&quot;</span> <span class="c1"># the input is extended by replicating the last pixel</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mirror&quot;</span><span class="p">):</span>
            <span class="n">BC</span> <span class="o">=</span> <span class="s2">&quot;reflect&quot;</span> <span class="c1"># reflecting about the center of the last pixel</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">BC</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;periodic&quot;</span><span class="p">):</span>
            <span class="n">BC</span> <span class="o">=</span> <span class="s2">&quot;wrap&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unknown BC type&quot;</span><span class="p">)</span>

        <span class="c1"># Set up PSF.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">PSF</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
                <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_GaussPSF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_size</span><span class="p">]),</span> <span class="n">PSF_param</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;moffat&quot;</span><span class="p">:</span>
                <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_MoffatPSF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_size</span><span class="p">]),</span> <span class="n">PSF_param</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PSF</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;defocus&quot;</span><span class="p">:</span>
                <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_DefocusPSF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PSF_size</span><span class="p">,</span> <span class="n">PSF_size</span><span class="p">]),</span> <span class="n">PSF_param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown PSF: </span><span class="si">{</span><span class="n">PSF</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># build forward model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_proj_forward_2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">BC</span><span class="p">),</span> 
                                       <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_proj_backward_2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">BC</span><span class="p">),</span> 
                                       <span class="n">range_geometry</span><span class="p">,</span> 
                                       <span class="n">domain_geometry</span><span class="p">)</span>

        <span class="c1"># User provided phantom as ndarray</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">phantom</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input phantom image must be an image (matrix) or vector&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phantom</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phantom</span><span class="p">))))</span>
                <span class="n">phantom</span> <span class="o">=</span> <span class="n">phantom</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
            <span class="n">phantom</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">imresize</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="c1"># Resize phantom (if wrong size)</span>
            <span class="n">x_exact2D</span> <span class="o">=</span> <span class="n">phantom</span>
        <span class="c1"># If phantom is string its a specific case</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># lowercase and replace hyphens with underscores to match library method names</span>
            <span class="n">phantom</span> <span class="o">=</span> <span class="n">phantom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> 
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cuqi</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">phantom</span><span class="p">):</span>
                <span class="n">x_exact2D</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cuqi</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">phantom</span><span class="p">)(</span><span class="n">size</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phantom </span><span class="si">{</span><span class="n">phantom</span><span class="si">}</span><span class="s2"> not found in cuqi.data phantom library.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unknown phantom type. Must be ndarray or string.&quot;</span><span class="p">)</span>

        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">x_exact2D</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">x_exact</span> <span class="o">=</span> <span class="n">CUQIarray</span><span class="p">(</span><span class="n">x_exact</span><span class="p">,</span> <span class="n">is_par</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">)</span>

        <span class="c1"># Generate exact data (blurred)</span>
        <span class="n">y_exact</span> <span class="o">=</span> <span class="n">model</span><span class="nd">@x_exact</span>

        <span class="c1"># Create prior</span>
        <span class="k">if</span> <span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain_dim</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">domain_geometry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># Data distribution</span>
        <span class="k">if</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="n">data_dist</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="n">noise_std</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">range_geometry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;scaledgaussian&quot;</span><span class="p">:</span>
            <span class="n">data_dist</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="p">(</span><span class="n">y_exact</span><span class="o">*</span><span class="n">noise_std</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">range_geometry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This noise type is not implemented&quot;</span><span class="p">)</span>
        
        <span class="c1"># Generate noisy data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_dist</span><span class="p">(</span><span class="n">x_exact</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

        <span class="c1"># Likelihood</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">data_dist</span><span class="o">.</span><span class="n">to_likelihood</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Initialize Deconvolution as BayesianProblem problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="n">x_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="n">y_exact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infoString</span> <span class="o">=</span> <span class="s2">&quot;Noise type: Additive </span><span class="si">{}</span><span class="s2"> with std: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">noise_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span><span class="n">noise_std</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Miscellaneous</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PSF&quot;</span> <span class="p">:</span> <span class="n">P</span><span class="p">,</span> <span class="s2">&quot;BC&quot;</span><span class="p">:</span> <span class="n">BC</span><span class="p">}</span></div>
</div>


<span class="c1">#=========================================================================</span>
<span class="k">def</span> <span class="nf">_proj_forward_2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">BC</span><span class="p">):</span>
    <span class="n">PSF_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">X_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">PSF_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">BC</span><span class="p">)</span>
    <span class="n">Ax</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">X_padded</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PSF_size</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">:</span> <span class="c1"># If PSF_size is even</span>
        <span class="n">Ax</span> <span class="o">=</span> <span class="n">Ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># Remove first row and column to fit convolve math</span>
    <span class="k">return</span> <span class="n">Ax</span>

<span class="c1">#=========================================================================</span>
<span class="k">def</span> <span class="nf">_proj_backward_2D</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">BC</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">P</span><span class="p">))</span> <span class="c1"># Flip PSF</span>
    <span class="k">return</span> <span class="n">_proj_forward_2D</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span>

<span class="c1"># ===================================================================</span>
<span class="c1"># Array with PSF for Gaussian blur (astronomic turbulence)</span>
<span class="c1"># ===================================================================</span>
<span class="k">def</span> <span class="nf">_GaussPSF</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span>
    
    <span class="c1"># Set up grid points to evaluate the Gaussian function</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Compute the Gaussian, and normalize the PSF.</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span> <span class="p">((</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">PSF</span> <span class="o">/=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># find the center</span>
    <span class="n">mm</span><span class="p">,</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PSF</span> <span class="o">==</span> <span class="n">PSF</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># ===================================================================</span>
<span class="c1"># Array with PSF for Moffat blur (astronomical telescope)</span>
<span class="c1"># ===================================================================</span>
<span class="k">def</span> <span class="nf">_MoffatPSF</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span>
    
    <span class="c1"># Set up grid points to evaluate the Gaussian function</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Compute the Gaussian, and normalize the PSF.</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF</span> <span class="o">/</span> <span class="n">PSF</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># find the center</span>
    <span class="n">mm</span><span class="p">,</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PSF</span> <span class="o">==</span> <span class="n">PSF</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># ===================================================================</span>
<span class="c1"># Array with PSF for out-of-focus blur</span>
<span class="c1"># ===================================================================</span>
<span class="k">def</span> <span class="nf">_DefocusPSF</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span>
    
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">R</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>    
        <span class="c1"># the PSF is a delta function and so the blurring matrix is I</span>
        <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">PSF</span><span class="p">[</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">aa</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">PSF</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF</span> <span class="o">/</span> <span class="n">PSF</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="c1">#=============================================================================</span>
<div class="viewcode-block" id="WangCubic">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.WangCubic.html#cuqi.testproblem.WangCubic">[docs]</a>
<span class="k">class</span> <span class="nc">WangCubic</span><span class="p">(</span><span class="n">BayesianProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Two parameters and one observation cubic test problem.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    noise_std : scalar</span>
<span class="sd">        Standard deviation of the noise</span>

<span class="sd">    prior : cuqi.distribution.Distribution</span>
<span class="sd">        Distribution of the prior</span>
<span class="sd">    </span>
<span class="sd">    data : scalar</span>
<span class="sd">        Observed data</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Based on Section 3.3.2 in Wang (2015):</span>
<span class="sd">    Z. Wang, &quot;An Optimization Based Algorithm for Bayesian Inference&quot;. Master thesis. MIT. 2015  </span>
<span class="sd">    https://dspace.mit.edu/bitstream/handle/1721.1/98815/921147308-MIT.pdf?sequence=1&amp;isAllowed=y</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="WangCubic.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/cuqi.testproblem/cuqi.testproblem.WangCubic.__init__.html#cuqi.testproblem.WangCubic.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># forward model and gradient</span>
        <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">30</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]])</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">range_geometry</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">domain_geometry</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">jacobian</span><span class="p">)</span>

        <span class="c1"># define prior</span>
        <span class="k">if</span> <span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># data</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># data distribution is Gaussian</span>
        <span class="n">data_dist</span> <span class="o">=</span> <span class="n">cuqi</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">prior</span><span class="p">),</span> <span class="n">noise_std</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Define Gaussian likelihood</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">data_dist</span><span class="o">.</span><span class="n">to_likelihood</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Set up Bayesian Problem</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>

        <span class="c1"># Store exact values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactSolution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exactData</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infoString</span> <span class="o">=</span> <span class="s2">&quot;Noise type: Additive </span><span class="si">{}</span><span class="s2"> with std: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">)</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2022, CUQI Project, Technical University of Denmark (DTU).
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>